---
import { render } from "astro:content";
import Root from "../layouts/root.astro";
import Button from "./_button.astro";
import { getEntry } from "astro:content";

export const prerender = true;

const page = await getEntry("pages", "tip-me")!;
const { Content } = await render(page);
---

<script>
  import { loadStripe } from "@stripe/stripe-js";
  import { actions } from "astro:actions";
  import { PUBLIC_STRIPE_KEY } from "astro:env/client";

  void main();

  async function main() {
    const stripe = await loadStripe(PUBLIC_STRIPE_KEY);
    const checkout = await stripe?.initEmbeddedCheckout({
      async fetchClientSecret() {
        const result = await actions.createCheckoutSession();
        if (result.error) throw result.error;
        return result.data.clientSecret;
      },
    });
    document.querySelector("#spinner")?.remove();
    checkout?.mount("#checkout");
  }
</script>

<Root>
  <div
    class="flex justify-center items-start lt-md:(flex-col justify-stretch items-center) gap-4 p-4 children:max-w-md"
  >
    <div class="grow-1 w-full space-y-4">
      <Button tag="a" href="/">Go Back</Button>
      <div
        id="checkout"
        class="p-4 bg-white rounded-3xl overflow-hidden min-h-2xl"
      >
      </div>
    </div>
    <div
      class="flex-1 px-8 py-4 md:mt-14 bg-white rounded-3xl space-y-2 richtext"
    >
      <Content />
    </div>
  </div>
</Root>
